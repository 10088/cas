<!DOCTYPE html>
<html xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="layout">

<head>
    <title th:text="#{cas.mfa.u2f.pagetitle}"></title>
    <script th:src="@{/js/u2f/u2f-api.js}"></script>

    <script th:inline="javascript">
        /*<![CDATA[*/
        
        setTimeout(function() {
            var appId =  /*[[${u2fReg.appId}]]*/ ;;
            var version =  /*[[${u2fReg.version}]]*/ ;;
            var challenge =  /*[[${u2fReg.challenge}]]*/ ;;

            var registerRequests = [{version: version, challenge: challenge}];
            console.log(appId, registerRequests);
            u2f.register(appId, registerRequests, [], function(data) {
                var form = document.getElementById('form');
                var reg = document.getElementById('tokenResponse');
                if (data.errorCode) {
                    console.log("U2F failed: error " + data.errorCode);
                    return;
                }
                reg.value = JSON.stringify(data);
                form.submit();
            });
        }, 1000);

        /*]]>*/
    </script>

</head>

<body id="cas">
<div layout:fragment="content">
    <div class="box fl-panel" id="login">
        <form method="POST" id="form">
            <input type="hidden" name="tokenResponse" id="tokenResponse"/>
            <input type="hidden" name="_eventId" value="submit"/>
            <input type="hidden" name="execution" th:value="${flowExecutionKey}"/>
        </form>
    </div>
</div>
</body>
</html>
